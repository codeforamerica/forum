<section>

  <h2 class="inline"><%= @issue.title %></h2>

  <ul class="labels right">

    <% @issue.labels.each do |label| %>

      <li class="left" style="background-color: <%= "##{label.color}" %>;">
        <a href="/forum/l/<%= label.name %>"><%= label.name %></a>
      </li>

    <% end %>

  </ul>
  <div class="clear"></div>

  <h6 class="inline">Started by <a href="<%= @issue.user.html_url %>"><%= @issue.user.login %></a></h6>

  <% if authenticated?%>

    <% if github_user.login == @issue.user.login %>

      <a class="button-s inline right icon-tools" href=<%="#{request.url}/edit"%> >Edit</a>
      <div class="clear"></a>

    <% end %>

  <% end %>
  
  <p><%= @issue.body %></p>

  <hr />

  <ul id="comments" class="list-ruled">

    <% @comments.each do |comment| %>

      <li>
        
        <h6 class="inline"><a href="<%= comment.user.html_url %>"><%= comment.user.login %></a></h6>
        <% if authenticated? %>

          <% if github_user.login == comment.user.login %>

            <a class="button-s inline right icon-tools" href="<%= request.url %>/comment/<%= comment.id %>/edit">Edit</a>
            <div class="clear"></a>

          <% end %>

        <% end %>
        <p><%= comment.body %></p>

      </li>
    <% end %>

  </ul>

  <% if authenticated? %>

    <form id="new-comment" method="POST">
      <textarea id="comment-field" name="comment"></textarea>
      <input type="submit" value="Add comment" class="icon-bubble" />
      <small class="note"><a href="https://github.com/codeforamerica/codeofconduct">Don't be a jerk</a>.</small>
    </form>

<% end %>

</section>

<script>

    $('#new-comment').on('submit', function (e) {
        e.preventDefault();
        url = "http://localhost:4567/forum/<%= @repo_string %>/<%= @issue.number %>/comment";
        data = {"comment" : $("#comment-field").val() }
        $.post(url, data);
        $("#comment-field").empty();
        setTimeout(checkForNewComments,3000);
    });

    function checkForNewComments(){
        $.getJSON("http://localhost:4567/forum/<%= @repo_string %>/<%= @issue.number %>/updates?time=<%= @time %>", function(response){

            $.each(response, function(i){
                html = '<li><h6 class="inline"><a href='+response[i].html_url+'>'+response[i].login+'</a></h6>'+response[i].body+'</li>';
                $("#comments").append(html);
            })

            setTimeout(checkForNewComments,30000);

        });

    }

    setTimeout(checkForNewComments,30000);
</script>
